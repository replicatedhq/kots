name: kurl-addon-test

on:
  workflow_dispatch:
    inputs:
      addon_version:
        type: string
        description: "Kots version."
        required: true
      s3_prefix:
        type: string
        description: "S3 key prefix."
        default: "test/"
      priority:
        type: number
        description: 'Testgrid run priority.'
        default: 0
  workflow_call:
    inputs:
      addon_version:
        type: string
        description: "Kots version."
        required: true
      s3_prefix:
        type: string
        description: "S3 key prefix."
        default: "test/"
      priority:
        type: number
        description: 'Testgrid run priority.'
        default: 0
    outputs:
      addon_package_url:
        description: "S3 package url"
        value: ${{ jobs.generate-kots-addon.outputs.addon_package_url }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-kots-addon:
    uses: ./.github/workflows/kurl-addon-kots-generate.yaml
    with:
      addon_version: "${{ inputs.addon_version }}"
      s3_prefix: "${{ inputs.s3_prefix }}"
    secrets: inherit

  test-kots-addon:
    runs-on: ubuntu-20.04
    needs: generate-kots-addon
    steps:
      - uses: actions/checkout@v3
      - name: set outputs
        id: vars
        run: |
          echo "::set-output name=sha_short::${GITHUB_SHA:0:7}"
          echo "::set-output name=ref_name::${GITHUB_REF_NAME//\//"-"}" # replace forward slashes
      - uses: replicatedhq/kurl/.github/actions/addon-testgrid-tester@main
        with:
          addon: "kotsadm"
          version: "${{ inputs.addon_version }}"
          package-url: "${{ needs.generate-kots-addon.outputs.addon_package_url }}"
          testgrid-spec-path: "deploy/kurl/kotsadm/template/testgrid"
          testgrid-run-prefix: "KOTS-${{ inputs.addon_version }}-${{ steps.vars.outputs.ref_name }}-${{ steps.vars.outputs.sha_short }}"
          testgrid-api-token: "${{ secrets.TESTGRID_PROD_API_TOKEN }}"
          priority: "${{ inputs.priority }}"
